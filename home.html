<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link href="https://fonts.googleapis.com/css?family=Fira+Sans&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <title>Tracker App</title>
</head>

<body>
    <!-- HEADER -->
    <div class="header_image">
        <div class="header_block">
        </div>
        <div class="header_text">
            <h1 id="header">TRACKER APP</h1>
        </div>
    </div>

    <!-- SUBSCRIPTIONS -->
    <div class="section">
        <div id='userInfoWrapper'></div>
        <h4 class="sectionTitle">STARRED TRACKERS</h4>
        <div class="displayTime">
            <h1 id="time" class="currentTime"></h1>
        </div>


        <!-- <div id='fav1' class='starredTracker'></div>
        <div id='fav2' class='starredTracker'></div>
        <div id='fav3' class='starredTracker'></div>
    </div>
    <div id='subscriptionsTextWrapper'>
        <h2>Subscriptions</h2>
    </div>
    <div id='subscriptionsWrapper'>
        <div id='sub1' class='subscription'></div>
        <div id='sub2' class='subscription'></div>
        <div id='sub3' class='subscription'></div>
        <div id='sub4' class='subscription'></div>
        <div id='sub5' class='subscription'></div>
        <div id='sub6' class='subscription'></div>
    </div> -->
        <div id="firebaseui-auth-container"></div>


        <div id='fav1' class="tracker">
            <div class="col-1">
                <p id="starred-1" class="starred-trackers">Netflix</p>
            </div>
            <div class="col-2">
                <img id="netflix" class="time-btn" width="25px" src="images/record.png" onclick=(countTime(this.id))>
            </div>
        </div>
        <div id='fav2' class="tracker">
            <div class="col-1">
                <p id="starred-2" class="starred-trackers">Spotify</p>
            </div>
            <div class="col-2">
                <img id="spotify" class="time-btn" src="images/record.png" onclick=(countTime(this.id))>
            </div>
        </div>
        <div id='fav3' class="tracker">
            <div class="col-1">
                <p id="starred-3" class="starred-trackers">Amazon Prime</p>
            </div>
            <div class="col-2">
                <img id="amazon" class="time-btn" src="images/record.png" onclick=(countTime(this.id))>
            </div>
        </div>
    </div>

    <!-- SUBSCRIPTIONS -->
    <div class="section">
        <h4 class="sectionTitle">SUBSCRIPTIONS</h4>
        <div class="sub-col-1">
            <a href="sub-netflix.html"><img class="sub-icons" id="netflix" src="images/netflix.png"></a>
        </div>
        <div class="sub-col-2">
            <img class="sub-icons" id="spotify" src="images/spotify.png">
        </div>
        <div class="sub-col-3">
            <img class="sub-icons" id="prime" src="images/prime.png">
        </div>
    </div>
    <!-- asdsa -->



    <script src="https://www.gstatic.com/firebasejs/7.2.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.2/firebase-firestore.js"></script>
    <script src="https://cdn.firebase.com/libs/firebaseui/3.5.2/firebaseui.js"></script>
    <script src="js/firebase_setup.js"></script>
    <script src="js/app.js"></script>

    <script>
        let display = document.getElementById("time");
        let startTime, endTime, newTime, timeInterval;
        let run = false;

        function setStarredTrackers(userID) {
            let ref = db.doc(`users/${userID}`).get().then(function (doc) {
                let user = doc.data();
                makeStarredTracker(user.favorites);
            })
        }

        function makeStarredTracker(fav) {
            for (let i = 0; i < fav.length; i++) {
                let favName = fav[i];
                let favButton = document.getElementById(`fav${i + 1}`)
                favButton.onclick = function () {
                    localStorage.setItem('subName', favName);
                    location.href = "sub.html";
                }
            }
        }

        function setSubscriptions(userID) {
            let ref = db.doc(`users/${userID}`).get().then(function (doc) {
                let user = doc.data();
                makeSubscriptions(user.subscriptions);
            })
        }

        function makeSubscriptions(sub) {
            let subLength = sub.length;
            for (let i = 0; i < sub.length; i++) {
                let subName = sub[i];
                let subButton = document.createElement('button');

                subButton.innerHTML = titleCase(sub[i]);
                subButton.class = 'subButton'
                document.getElementById(`sub${i + 1}`).appendChild(subButton);
            }
            let addSub = document.createElement('button');
            addSub.innerHTML = 'Add Subscription';
            addSub.id = 'addSub'
            document.getElementById('subscriptionsWrapper').appendChild(addSub);
        }

        function countTime(btnID) {
            if (!run) {
                startTime = new Date().getTime();
                timeInterval = setInterval(displayTime, 1000);
                run = true;
                document.getElementById(btnID).src = "images/stop.png";
            }
            else {
                run = false;
                document.getElementById(btnID).src = "images/record.png";
                clearInterval(timeInterval);
                if (confirm("Do you want to save this time?")) {
                    //save to database
                    document.getElementById("time").innerHTML = "";
                }
                else {
                    document.getElementById("time").innerHTML = "";
                }
                endTime = new Date().getTime()
                let sessionTime = Math.floor((endTime - startTime) / 1000);
                let strSessionTime = sessionTime.toString();
                updateUserTime(strSessionTime, btnID);
            }
            let today = new Date();
            let date = today.getFullYear() + '-' + (today.getMonth() + 1) + '-' + today.getDate();
            let time = today.getHours() + ":" + today.getMinutes() + ":" + today.getSeconds();
            let dateTime = date + ' ' + time;
            let myDate = localStorage.setItem('date', date);
            console.log(dateTime);
        }

        function updateUserTime(value, btnID) {
            let date = new Date().toDateString() + " " + new Date().toTimeString();
            let ref = db.doc(`users/${userID}`).get().then(function (doc) {
                let user = doc.data();
                Promise.all([user, value]).then(function () {
                    db.collection("users").doc(`${userID}`).collection(btnID).doc(date).set({
                        'time': parseInt(value),
                    })
                    localStorage.setItem('subName', btnID);
                    localStorage.setItem('date', date);
                    localStorage.setItem('time', value);
                })
            })

        }

        // function updateUserTime(value) {
        //     let ref = db.doc(`users/${userID}`).get().then(function (doc) {
        //         let user = doc.data();
        //         Promise.all([user, value]).then(function () {
        //             db.collection("users").doc(`${userID}`).set({
        //                 'time': value,

        //             }, { merge: true})
        //             console.log("merge successful");
        //         })
        //     })
        // }
        // let timeArray = [];
        // function updateUserTime(value) {
        //     let ref = db.doc("users/${userID}").get().then(function (doc) {
        //         console.log("this is " + ref);
        //         let user = doc.data();
        //         db.collection("users").doc(`${userID}`).set({
        //             'time': timeArray.push(value),
        //         }, { merge: true })
        //         console.log(timeArray);
        //         console.log("merge successful");
        //     })
        // }


        function displayTime() {
            endTime = new Date().getTime();
            newTime = endTime - startTime;
            let hours = Math.floor((newTime % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            let minutes = Math.floor((newTime % (1000 * 60 * 60)) / (1000 * 60));
            let seconds = Math.floor((newTime % (1000 * 60)) / 1000);

            if (hours < 10) {
                hours = "0" + hours;
            }

            if (minutes < 10) {
                minutes = "0" + minutes;
            }

            if (seconds < 10) {
                seconds = "0" + seconds;
            }
            display.innerHTML = hours + ":" + minutes + ":" + seconds;
        }




        // Invocation
        // displayUserName();
        // displayUserEmail();
        // setStarredTrackers('user 1'); // Replace to generic user later!
        // setSubscriptions('user 1'); // Replace to generic user later!


        let userID = localStorage.getItem('userID')

    </script>

</body>

</html>